<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blogging App</title>
    <link rel="stylesheet" href="assests/css/main.css" />
    <link rel="stylesheet" href="assests/css/responsive.css" />
    <link rel="stylesheet" href="assests/css/dashboard.css" />
    <!-- font awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <!-- header start -->
    <header>
      <!-- navbar start -->
      <nav class="navbar container-fluid">
        <a href="index.html"><h4>Blogging App</h4></a>
        <div>
          <a class="login_signup" id="userName" href="profile.html"
            >User name</a
          >
          <a class="login_signup" id="logoutBtn">Logout</a>
        </div>
      </nav>
      <!-- navbar end -->
      <div class="container-fluid page-title">
        <!-- greeting for users -->
        <h1 class="greetings">Dashboard</h1>
      </div>
    </header>
    <!-- header end -->

    <main class="container-fluid">
      <section class="posting-blog">
        <form id="posting-form">
          <input
            type="text"
            placeholder="Post Title"
            title="Write a title for your post"
            minlength="5"
            maxlength="50"
            id="postTitle"
            autocomplete="off"
          />

          <textarea
            id="postText"
            cols="30"
            rows="10"
            placeholder="What's in your mind?"
            title="What's in your mind?"
            minlength="100"
            maxlength="3000"
            autocomplete="off"
          ></textarea>
          <button type="submit" id="pubBtn">Publish Blog</button>
        </form>
      </section>

      <h2>My Blogs</h2>
      <br />
      <section class="post-container">
        <div class="post-card">
          <div class="post-info">
            <img src="assests/images/writer-dp.jpg" class="author-dp" />
            <div>
              <h3 class="post-title">Introducing Whisper</h3>
              <div class="post-author">
                <span>Elon Musk</span> - <span>Aug 17th, 2023</span>
              </div>
            </div>
          </div>

          <div class="post-content">
            
          </div>

          <div class="content-edit">
            <button id="delBtn" type="button">Delete</button>
            <!-- <button id="delBtn" type="button">Edit</button> -->
          </div>
        </div>
      </section>
    </main>

    <!-- javascript -->
    <script type="module" src="assests/js/main.js"></script>
    <script type="module" src="assests/js/firebase.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- firebase -->
    <script type="module">
      // Firebase Configs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        remove,
        // onValue,
        // update,
        // remove,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDjWgkEDZI6dPWbai_OJ6KLKI9A8l83m4I",
        authDomain: "blogapp-c7488.firebaseapp.com",
        databaseURL: "https://blogapp-c7488-default-rtdb.firebaseio.com",
        projectId: "blogapp-c7488",
        storageBucket: "blogapp-c7488.appspot.com",
        messagingSenderId: "889483622671",
        appId: "1:889483622671:web:8eef199be7330f2418667a",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase();

      let userCreds = JSON.parse(localStorage.getItem("user-creds"));
      let userInfo = JSON.parse(localStorage.getItem("user-info"));
      let userName = document.getElementById("userName");
      let logoutButton = document.getElementById("logoutBtn");
      let deleteButton = document.getElementById("delBtn");

      // ...

      // Publishing Posts
      const postTitleInput = document.getElementById("postTitle");
      const postTextInput = document.getElementById("postText");
      const publishButton = document.getElementById("pubBtn");

      const date = new Date();

      const formattedDate = new Intl.DateTimeFormat("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      }).format(date);

      const dayWithSuffix =
        date.getDate() +
        (date.getDate() % 10 === 1 && date.getDate() !== 11
          ? "st"
          : date.getDate() % 10 === 2 && date.getDate() !== 12
          ? "nd"
          : date.getDate() % 10 === 3 && date.getDate() !== 13
          ? "rd"
          : "th");

      const finalFormattedDate = formattedDate.replace(/\d+/, dayWithSuffix);

      function addPost(e) {

        e.preventDefault();
        const postIdInput = Date.now();
        const postTitle = postTitleInput.value.trim();
        const postText = postTextInput.value.trim();

        if (postTitleInput.value === "" || postTextInput.value === "") {
          swal("Please fill in all fields!", "", "error");
          return;
        }

        set(ref(db, `Posts/${userInfo.firstName}-${postIdInput}`), {
          postInfo: {
            PostTitle: postTitleInput.value,
            PostText: postTextInput.value,
            PostDate: finalFormattedDate
          },
        })
          .then(() => {
            swal("Blog Posted", "", "success");
            postTitleInput.value = "";
            postTextInput.value = "";
          })
          .catch((error) => {
            console.error(error.code);
            console.error(error.message);
          });
      }

      publishButton.addEventListener("click", addPost);
      // ...

      // // Function to create a post card element
      function createPostCard(post) {
        const postCard = document.createElement("div");
        postCard.className = "post-card";

        // Create post info section
        const postInfo = document.createElement("div");
        postInfo.className = "post-info";

        // Create author DP element
        const authorDp = document.createElement("img");
        authorDp.src = "assests/images/writer-dp.jpg";
        authorDp.className = "author-dp";

        // Create title and author info section
        const titleAndAuthor = document.createElement("div");

        // Create post title element
        const postTitle = document.createElement("h3");
        postTitle.className = "post-title";
        postTitle.textContent = post.postInfo.PostTitle;

        // Create post author info element
        const postAuthor = document.createElement("div");
        postAuthor.className = "post-author";
        postAuthor.innerHTML = `<span>${userInfo.firstName} ${userInfo.lastName}</span> - <span>${finalFormattedDate}</span>`;

        // Append elements to title and author info section
        titleAndAuthor.appendChild(postTitle);
        titleAndAuthor.appendChild(postAuthor);

        // Append elements to post info section
        postInfo.appendChild(authorDp);
        postInfo.appendChild(titleAndAuthor);

        // Create post content element
        const postContent = document.createElement("div");
        postContent.className = "post-content";
        postContent.textContent = post.postInfo.PostText;

        // Create content edit section
        const contentEdit = document.createElement("div");
        contentEdit.className = "content-edit";

        // Create delete button
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.setAttribute("id", "delBtn");
        deleteButton.setAttribute("type", "button");

        // Create edit button
        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.setAttribute("id", "editBtn");
        editButton.setAttribute("type", "button");

        // Append buttons to content edit section
        contentEdit.appendChild(deleteButton);
        contentEdit.appendChild(editButton);

        // Append elements to post card
        postCard.appendChild(postInfo);
        postCard.appendChild(postContent);
        postCard.appendChild(contentEdit);

        return postCard;
      }

      // Function to prepend new posts to the existing container
      function prependPostsToContainer(postContainer, posts) {
        posts.forEach((post) => {
          // Create and prepend post card to post container
          postContainer.insertBefore(
            createPostCard(post),
            postContainer.firstChild
          );
        });
      }

      // Function to retrieve and display posts
      function displayPostsFromFirebase() {
        const postsRef = ref(db, "Posts");

        // Use the 'on' method to listen for changes in real-time
        onValue(postsRef, (snapshot) => {
          const postContainer = document.querySelector(".post-container");

          // Convert the snapshot to an array of posts
          const posts = [];
          snapshot.forEach((childSnapshot) => {
            const post = childSnapshot.val();
            post.id = childSnapshot.key;
            posts.push(post);
          });

          prependPostsToContainer(postContainer, posts);
        });
      }

      displayPostsFromFirebase();

      //------- Funtion to Delete Posts from firebase
      function deletePost() {
        remove(ref(db, "Posts"))
          .then(() => {
            swal("Post Deleted", "", "success");
          })
          .catch((error) => {
            console.error(error.code);
            console.error(error.message);
          });
        console.log("Dele");
      }

      deleteButton.addEventListener("click", deletePost);

      // Signout
      let signOut = () => {
        localStorage.removeItem("user-creds");
        localStorage.removeItem("user-info");
        window.location.href = "login.html";
      };

      // Check if user is Logged in
      let ifUserLogin = () => {
        if (!localStorage.getItem("user-creds")) {
          window.location.href = "login.html";
        } else {
          logoutButton.style.display = "block";
          userName.innerText = `${
            userInfo.firstName + " " + userInfo.lastName
          }`;
        }
      };

      window.addEventListener("load", ifUserLogin);
      logoutButton.addEventListener("click", signOut);
    </script>
  </body>
</html>
